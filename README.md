# ter_vm_dev

cd /mnt/c/Users/rlyst/Netology/ter-final/src

Данный Terraform код предназначен для автоматизированного создания и настройки инфраструктуры в облаке Yandex Cloud с использованием официального Terraform-провайдера.

**Основные технические функции этого кода:**

- **Локальные переменные:**  
  Определяет локальную переменную `serial-port-enable`, которая используется в метаданных ВМ для включения последовательного порта.

- **Модуль создания VPC (`yandex-vpc`):**  
  Конфигурирует виртуальную частную сеть с одной подсетью в заданной зоне. Создаёт группу безопасности с правилами для входящего трафика по TCP-портам 22 (SSH), 80 (HTTP) и 443 (HTTPS) из любого источника, а также разрешает весь исходящий трафик. Модуль реализован как отдельный блок для повторного использования и параметризации.

- **Модуль создания виртуальных машин (`web-vm`):**  
  Создаёт заданное количество виртуальных машин с параметрами из переменных (имя, зона, образ Ubuntu, платформа, CPU, память, размер диска, публичный IP). ВМ подключаются к подсетям, получают сетевые настройки, назначаются в группу безопасности "web". В метаданных ВМ передаётся скрипт cloud-init для настройки при запуске, а также параметр `serial-port-enable`. Для каждого экземпляра устанавливаются метки окружения и роли.

- **Данные и шаблоны:**  
  Используется `data "template_file"` для чтения и подстановки SSH-ключа в cloud-init конфигурацию. Получается версия образа Ubuntu по семейству.

- **Выводы (`outputs`):**  
  Возвращает приватные IP-адреса всех веб-ВМ и SSH-команды для подключения к ним по публичным IP.

- **Конфигурация Terraform:**  
  Определён `backend` с использованием S3-совместимого хранилища от Yandex Object Storage и DynamoDB-подобной таблицей для блокировки состояния, что обеспечивает надёжное хранение и совместную работу с состоянием инфраструктуры.  
  Включены необходимые провайдеры (`yandex` и `template`), требования по версиям провайдеров и Terraform.

- **Провайдер Yandex Cloud:**  
  Настраивается с передачей идентификаторов облака, папки, зоны и файла с ключём сервисного аккаунта для аутентификации и работы с API Yandex Cloud.

- **Переменные:**  
  Задаются переменные для идентификаторов облака и папки, конфигурации VPC (зоны, CIDR подсети), параметров ВМ (образ, SSH-ключ), а также параметризированный список веб-серверов с их вычислительными ресурсами, количеством и прочими настройками.

То есть, в техническом плане код:

- Создаёт виртуальную сеть (VPC) с настроенными подсетями и группами безопасности.  
- Запускает несколько виртуальных машин с заданными параметрами, подключая их к этой сети и обеспечивая доступ по SSH и HTTP/HTTPS.  
- Управляет конфигурацией ВМ через cloud-init (автоматическая настройка при старте).  
- Хранит состояние инфраструктуры в удалённом объектном хранилище с блокировкой для безопасности доступа.  
- Позволяет выводить важные для работы адреса и команды для подключения.

Такой подход позволяет эффективно и повторяемо развертывать и поддерживать заданную инфраструктуру в Yandex Cloud через Terraform.

# Параметры конфигурации

### Для создания VPC и подсети (в модуле `yandex-vpc`):

- `env_name` — строка, задаёт название окружения, например, "production".
- `subnets` — список подсетей, где каждый элемент содержит:
  - `zone` — зона доступности, здесь используется значение из `var.vpc_default_zone[2]` (например, "ru-central1-d").
  - `cidr` — IP-диапазон подсети в формате CIDR, например, `"10.0.1.0/24"`.
- `security_groups` — список групп безопасности, где каждая группа содержит:
  - `name` — имя группы ("web").
  - `description` — описание группы.
  - `ingress_rules` — правила входящего трафика, указывающие:
    - `protocol` — протокол (в данном случае TCP).
    - `port` — порт (80, 443, 22).
    - `cidr_blocks` — диапазоны IP-адресов, откуда разрешён доступ (все адреса 0.0.0.0/0).
    - `description` — описание правила.
  - `egress_rules` — правила исходящего трафика:
    - `protocol` — "ANY" означает любой протокол.
    - `cidr_blocks` — диапазон IP, куда разрешён выходящий трафик (0.0.0.0/0).
    - `description` — описание.

### Для создания виртуальных машин (в модуле `web-vm`):

- `vm_name` — имя виртуальной машины из переменной (`var.web.instance_name`).
- `vm_count` — количество экземпляров (`var.web.instance_count`, например, 3).
- `zone` — зона развертывания ВМ (`var.vpc_default_zone[2]`).
- `subnet_ids` — список ID подсетей, куда подключать ВМ (получается из модуля VPC).
- `image_id` — ID образа ОС (например, Ubuntu из семейства `var.vm_web_image_family`).
- `platform_id` — тип виртуальной машины (например, "standard-v3").
- `cores` — количество CPU ядер (например, 2).
- `memory` — объём оперативной памяти в ГБ (например, 2).
- `disk_size` — размер системного диска в ГБ (например, 10).
- `public_ip` — флаг наличия публичного IP (true или false).
- `security_group_ids` — ID группы безопасности, к которой привязана ВМ (группа "web" из модуля VPC).
- `labels` — метки в формате ключ/значение (например, `env` и `role`).
- `metadata` — дополнительные метаданные ВМ:
  - `user-data` — скрипт cloud-init для начальной настройки ВМ (с SSH ключом).
  - `serial-port-enable` — значение `1`, включающее последовательный порт.

### Провайдер и backend:

- `provider "yandex"` конфигурируется через:
  - `cloud_id` — ID облака.
  - `folder_id` — ID папки (каталога).
  - `zone` — зона по умолчанию.
  - `service_account_key_file` — путь к JSON-ключу сервисного аккаунта для авторизации.
- Backend S3 настраивается с параметрами:
  - `bucket` — имя бакета для хранения state-файла.
  - `key` — путь к файлу состояния внутри бакета.
  - `region` — регион (здесь `ru-central1`).
  - `endpoints` — URL для S3 и DynamoDB сервисов Яндекса.
  - Флаги пропуска валидаций, необходимые для работы с Яндекс-совместимым S3.

### Переменные:

- `vpc_default_zone` — список зон доступности (например, ru-central1-a, -b, -d).
- `vpc_default_cidr` — список CIDR блоков для подсетей.
- `vm_web_image_family` — семейство образов для ВМ (например, ubuntu-2404-lts).
- `vm_ssh_root_key` — путь к публичному SSH-ключу.
- `web` — список объектов с параметрами каждой группы веб-серверов, включающий:
  - `env_name`, `instance_name`, `instance_count`, `public_ip`, `platform_id`, `cores`, `memory`, `disk_size`, `role`.

Эти параметры определяют точные характеристики создаваемых сетей и виртуальных машин, обеспечивая контроль над зоной размещения, размером ресурсов, сетевыми настройками и правилами безопасности, а также автоматическую первоначальную настройку ВМ через cloud-init. Такой уровень детализации позволяет полностью управлять нужной инфраструктурой в Yandex Cloud с помощью Terraform.

# Итого

- **Виртуальную частную сеть (VPC)** с одной подсетью в зоне `ru-central1-d` и заданным CIDR-блоком (например, `10.0.1.0/24`), которая будет использоваться для размещения виртуальных машин.

- **Группу безопасности "web"** с правилами:
  - Входящий TCP-трафик на порты 22 (SSH), 80 (HTTP) и 443 (HTTPS) разрешён с любых IP-адресов.
  - Исходящий трафик разрешён на все адреса и протоколы.

- **Виртуальные машины (ВМ)**:
  - Создаются в указанной подсети, в зоне `ru-central1-d`.
  - Количество ВМ задано переменной (например, 3 экземпляра).
  - Каждая ВМ использует образ Ubuntu (семейство `ubuntu-2404-lts`).
  - Конфигурация ВМ включает платформу (например, `standard-v3`), количество CPU ядер, объём оперативной памяти и размер диска, заданные в переменных.
  - Каждая ВМ получает публичный IP (если задано), сетевые параметры и принадлежит к группе безопасности "web".
  - На ВМ загружается cloud-init скрипт с настройками, включая SSH ключ для доступа и включение последовательного порта.

- **Хранение состояния Terraform** будет происходить в удалённом S3-совместимом хранилище Yandex Object Storage с использованием DynamoDB-подобного механизма блокировок, что обеспечивает надежное управление состоянием и предотвращение конфликтов при параллельной работе.

- **Вывод в консоль** после применения конфигурации предоставит приватные IP-адреса всех созданных ВМ, а также готовые SSH команды для подключения к ним по публичным IP.

Таким образом, после `terraform apply` у вас будет настроенный изолированный сетевой сегмент с необходимыми настройками безопасности и готовыми к использованию веб-серверами в облаке Yandex Cloud. Эта инфраструктура полностью управляется через Terraform, что обеспечивает удобство масштабирования, изменения параметров и автоматизации развертывания.